<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap"
    rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap"
    rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="icon" type="image/x-icon" href="../home/img/favicon.png">
  <link rel="stylesheet" href="../remover_contato/style.css">
  <title>Remover Contato</title>
</head>

<body>
  <!-- Cabeçalho da página -->
  <header class="cabeçalho">
    <a class="icone-menu" id="menu-icon">
      <img src="../home/img/icone-menu.png" alt="menu">
    </a>
    <img class="logo" src="../home/img/logo.png" alt="logo do site">
    <a class="perfil" href="../usuario/index.html"><img src="../home/img/perfil.png" alt="Imagem perfil"></a>
  </header>

  <!-- Sidebar (menu lateral oculto) -->
  <aside id="sidebar" class="sidebar oculto">
    <div class="logo-sidebar"><img src="../home/img/logo.png" alt="logo" width="80px">
      <h2>Vinculoo</h2>
    </div>
    <ul>
      <li><a href="../home/index.html"><img src="../home/img/menu-principal.png" alt="">Menu Principal</a></li>
      <li><a href="../adicionar_contato/index.html"><img src="../home/img/adicionar.png"> Adicionar Contato</a></li>
      <li><a href="../remover_contato/index.html"><img src="../home/img/remover.png"> Remover Contato</a></li>
      <li><a href="../editar_contato/index.html"><img src="../home/img/editar.png"> Editar Contato</a></li>
      <li><a href="../lista_de_contato/index.html"><img src="../home/img/listar.png"> Meus Contatos</a></li>
    </ul>
  </aside>

  <!-- Título principal -->
  <div class="titulo">
    <h1>Remover Contato ⟶</h1>
    <button class="botao-apagarLista" id="botao-apagarLista" type="submit">Apagar Lista<img
        src="../lista_de_contato/img/lixeira.png"></button>
  </div>

  <div class="quadro">
    <div class="fundo">
      <h1 class="subtitulo">Qual contato você deseja remover?</h1>

      <!-- Barra de Pesquisa -->
      <div class="centraliza">
        <div class="barraDeBusca">
          <img src="../home/img/lupa.png" alt="lupa" />
          <input type="text" id="barraPesquisa" class="textoDaBarra" placeholder="Procure algum contato salvo..."
            oninput="filtrarContatos()" />
        </div>
      </div>

      <!-- Cards de Contato -->
      <div class="lista">
        <!-- <div class="contato">
            <img class="imagem">
            <p class="nome">oiii</p>
            <p class="telefone">oiiiii</p>
            <p class="email"></p>
            <p class="parentesco"></p>
            <p class="empresa"></p>
            <p class="cargo"></p>
            <p class="aniversario"></p>
        </div> -->
      </div>
    </div>
  </div>

  <!-- Rodapé -->
  <footer>
    <div class="footer-container">
      <div class="redes-sociais">
        <img src="../remover_contato/img/redes.png" alt="Redes Sociais">
      </div>

      <div class="footer-column">
        <h1>Escritório Vinculoo no Brasil</h1>
        <p>R. Boa Vista, 825 - Boa Vista,</p>
        <p>São Caetano do Sul - SP, 09572-300</p>
      </div>

      <div class="footer-column">
        <h1>Para você</h1>
        <a href="../cadastro/index.html">Juntar</a>
        <a href="../login/index.html">Entrar</a>
        <a href="../usuario/index.html">Sua conta</a>
      </div>

      <div class="footer-column">
        <h1>Nossa empresa</h1>
        <a href="../sobre_nos/index.html">Sobre nós</a>
        <a href="../sobre_nos/index.html">Estamos contratando!</a>
        <a href="#">Política de Privacidade</a>
      </div>
    </div>

    <div class="linha-rodape"></div>

    <div class="footer-bottom">
      <div class="footer-logo">
        <img src="../home/img/logo.png" alt="Logo">
      </div>
      <p>© Todos os direitos reservados.</p>
    </div>
  </footer>

  <!-- Script para funcionamento da página -->
  <script>
    //JS DO SIDEBAR
    const sidebar = document.getElementById("sidebar"); //Pega o elemento do sidebar
    const menuIcon = document.getElementById("menu-icon"); //Pega o ícone do menu (três linhas ou botão de abrir menu)

    //Adiciona um evento de clique no ícone do menu
    menuIcon.addEventListener("click", function (event) {
      event.stopPropagation(); // Evita que o clique feche o menu
      sidebar.classList.toggle("oculto"); //Adiciona ou remove a classe "oculto" no sidebar, que faz o menu aparecer ou sumir
    });

    // Adiciona um evento de clique em qualquer parte da página
    document.addEventListener("click", function (event) {
      const clicouFora = !sidebar.contains(event.target) && !menuIcon.contains(event.target); //Verifica se clicou fora do sidebar e do ícone do menu
      if (clicouFora) { //Se clicou fora, adiciona a classe "oculto" no sidebar para fechar o menu
        sidebar.classList.add("oculto");
      }
    });

    
    let todosContatos = [];

    // Função que busca os contatos da API e mostra na tela
    function carregarContatos() {
      // Faz uma requisição para o endpoint da API que retorna os contatos
      fetch("http://127.0.0.1:3000/contatos")
        .then(response => response.json()) // Converte a resposta para JSON
        .then(contatos => {
          todosContatos = contatos;  // Armazena os contatos na variável global
          exibirContatos(contatos); // Chama função para exibir os contatos na tela
        })
        .catch(error => { // Se der erro na requisição
          console.log("Erro ao carregar contatos:", error); // Exibe o erro no console
        });
    }

    // Função para mostrar os contatos dentro da div com a classe ".lista"
    function exibirContatos(lista) {
      // Seleciona a div onde os contatos serão exibidos
      const listaDiv = document.querySelector('.lista');

      listaDiv.innerHTML = ''; // Limpa o conteúdo atual da lista para evitar duplicação

      // Se a lista estiver vazia, mostra uma mensagem informando que não há contatos
      if (lista.length === 0) {
        listaDiv.innerHTML = "<p>Nenhum contato encontrado.</p>";
        return; // Para a execução da função
      }

      // Para cada contato da lista, cria um elemento visual para exibir seus dados
      lista.forEach(contato => {
        const contatoDiv = document.createElement('div'); // Cria uma div para o contato
        contatoDiv.className = 'contato';                  // Define a classe CSS da div

        // Variável para armazenar informações extras opcionais (empresa, cargo, aniversário)
        let infoExtraHTML = '';

        // Se o contato tiver empresa, adiciona o HTML correspondente com ícone e texto
        if (contato.Empresa) {
          infoExtraHTML += `
            <div class="infos">
                <img src="../lista_de_contato/img/empresa.png" width="40px">
                <p class="texto">${contato.Empresa}</p>
            </div>`;
        }

        // Se o contato tiver cargo, adiciona o HTML correspondente com ícone e texto
        if (contato.Cargo) {
          infoExtraHTML += `
            <div class="infos">
                <img src="../lista_de_contato/img/cargo.png" width="40px">
                <p class="texto">${contato.Cargo}</p>
            </div>`;
        }

        // Se o contato tiver aniversário, adiciona o HTML correspondente com ícone e texto
        if (contato.Aniversario) {
          infoExtraHTML += `
            <div class="infos">
                <img src="../lista_de_contato/img/aniversario.png" width="40px">
                <p class="texto">${contato.Aniversario}</p>
            </div>`;
        }

        // Cria uma div para as informações extras apenas se houver alguma informação para mostrar
        const infoExtraDiv = infoExtraHTML ? `<div class="info-extra" id="extra-${contato.id}" style="display: none;">${infoExtraHTML}</div>` : '';

        // Verifica se o contato tem foto; se não, usa uma foto padrão
        const foto = contato.Foto ? contato.Foto : "../home/img/perfil.png";

        // Define o conteúdo HTML da div do contato, com imagem, nome, parentesco e infos básicas
        contatoDiv.innerHTML = `
        <img class="imagem" src="${foto}" alt="Foto de ${contato.Nome}" width="150px">
        <p class="nome">${contato.Nome}</p>
        <p class="parentesco">${contato.Parentesco}</p>

        <div class="infos">
            <img src="../lista_de_contato/img/telefone.png" width="40px">
            <p class="texto">${contato.Telefone}</p>
        </div>

        <div class="infos">
            <img src="../lista_de_contato/img/email.png" width="40px">
            <p class="texto">${contato.Email}</p>
        </div>

        ${infoExtraDiv}  <!-- Informações extras (empresa, cargo, aniversário) -->

        <button class="botao-excluir" onclick="excluirContato(${contato.id})">Excluir Contato</button>  <!-- Botão para excluir -->

        ${infoExtraDiv ? `<p class="ver-mais" onclick="toggleExtra(${contato.id})" id="toggle-${contato.id}">Ver Mais ▼</p>` : ''}  <!-- Botão para mostrar/esconder infos extras -->
    `;

        // Adiciona a div do contato na lista da página
        listaDiv.appendChild(contatoDiv);
      });
    }

    //BOTÃO EXCLUIR LISTA
    const botaoApagar = document.getElementById('botao-apagarLista');

    // Adiciona evento de clique no botão
    botaoApagar.addEventListener('click', function (e) {
      e.preventDefault(); // Evita comportamento padrão do botão (como enviar formulário)

      // Exibe alerta de confirmação usando SweetAlert2
      Swal.fire({
        title: 'Tem certeza?',
        text: "Essa ação vai apagar TODOS os seus contatos e não poderá ser desfeita!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#28bdd7',
        confirmButtonText: 'Sim, apagar tudo!',
        cancelButtonText: 'Cancelar'
      }).then((result) => {
        if (result.isConfirmed) {
          // Envia requisição DELETE para apagar todos os contatos
          fetch('http://127.0.0.1:3000/contatos', {
            method: 'DELETE'
          })
            .then(response => {
              if (response.ok) {
                // Se deu certo, mostra alerta de sucesso e recarrega a página
                Swal.fire(
                  'Apagado!',
                  'Todos os seus contatos foram removidos com sucesso.',
                  'success'
                ).then(() => {
                  window.location.reload(); // Recarrega a página
                });
              } else {
                // Se a resposta não for OK, mostra alerta de erro
                Swal.fire(
                  'Erro!',
                  'Não foi possível apagar os contatos.',
                  'error'
                );
              }
            })
            .catch(error => {
              // Se houve erro na conexão, mostra alerta de erro
              console.error('Erro:', error);
              Swal.fire(
                'Erro!',
                'Ocorreu um problema na conexão com o servidor.',
                'error'
              );
            });
        }
      });
    });

    //VER MAIS E VER MENOS
    function toggleExtra(id) {
      const extraDiv = document.getElementById(`extra-${id}`); // Seleciona a div extra
      const toggleText = document.getElementById(`toggle-${id}`); // Seleciona o texto "Ver Mais"

      // Alterna entre mostrar e esconder a div extra
      if (extraDiv.style.display === 'none') {
        extraDiv.style.display = 'block';
        toggleText.innerHTML = 'Ver Menos ▲'; // Altera o texto do botão
      } else {
        extraDiv.style.display = 'none';
        toggleText.innerHTML = 'Ver Mais ▼'; // Volta o texto original
      }
    }

    // FILTRA OS CONTATOS ENQUANTO DIGITA
    function filtrarContatos() {
      const texto = document.getElementById('barraPesquisa').value.toLowerCase(); // Pega o texto digitado

      // Filtra os contatos cujo nome contenha o texto digitado
      const filtrados = todosContatos.filter(contato =>
        contato.Nome.toLowerCase().includes(texto)
      );

      exibirContatos(filtrados); // Exibe apenas os contatos filtrados
    }

    //Botão excluir Contato
    function excluirContato(id) {
      // Exibe uma janela de confirmação usando SweetAlert
      Swal.fire({
        title: 'Tem certeza?', // Título da confirmação
        text: "Você quer excluir este contato? Essa ação não poderá ser desfeita!", // Mensagem de aviso
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#28bdd7',
        confirmButtonText: 'Sim, excluir!',
        cancelButtonText: 'Cancelar'
      }).then((result) => {  // Após o usuário responder à confirmação
        if (result.isConfirmed) {  // Se o usuário confirmou a exclusão
          // Envia uma requisição DELETE para a API para excluir o contato pelo ID
          fetch(`http://127.0.0.1:3000/contato/${id}`, {
            method: 'DELETE'  // Método HTTP DELETE indica exclusão
          })
            .then(response => {
              if (response.ok) { // Se a resposta for positiva 
                // Mostra uma mensagem de sucesso usando SweetAlert
                Swal.fire(
                  'Excluído!', // Título da mensagem
                  'O contato foi excluído com sucesso.', // Texto da mensagem
                  'success'  // Ícone de sucesso
                ).then(() => {
                  // Depois que o alerta for fechado, recarrega a página para atualizar a lista
                  window.location.reload();
                });
              } else {
                // Se a resposta não for positiva, mostra um alerta de erro
                Swal.fire(
                  'Erro!',
                  'Não foi possível excluir o contato.',
                  'error'
                );
              }
            })
            .catch(error => { // Caso ocorra algum erro na requisição (ex: falha de conexão)
              console.error('Erro:', error);  // Loga o erro no console para depuração
              // Exibe um alerta de erro informando problema na conexão com o servidor
              Swal.fire(
                'Erro!',
                'Ocorreu um problema na conexão com o servidor.',
                'error'
              );
            });
        }
      });
    }

    //Carrega os contatos quando abre a página
    window.onload = carregarContatos;
  </script>
</body>

</html>